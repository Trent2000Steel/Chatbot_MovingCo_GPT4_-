[...full code same as above, truncated for brevity...]